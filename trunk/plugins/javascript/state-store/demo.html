<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="lz-string-1.3.3-min.js"></script>
<script type="text/javascript">
var previousChildCount = 0;
var decodePointer = 0;

function tokenize(encoded)
{
	var parts = encoded.split('|');
	var tokenized = new Array();
	
	for(var i = 0; i < parts.length; i++)
	{
		if (tokenized[i] != null)
		{
			continue;
		}
		var found = false;
		var subject = parts[i];
		
		if (subject.length <= 1)
		{
			tokenized[i] = subject;
			continue;
		}
		
		for (var j = i + 1; j < parts.length; j++)
		{
			var compare = parts[j];
			
			if (compare == subject)
			{
				tokenized[j] = i;
			}
		}
		if (!found)
		{
			tokenized[i] = subject;
		}
	}
	
	return tokenized.join('|');
}

function untokenize(encoded)
{
	var parts = encoded.split('|');
	var untokenized = new Array();
	
	for(var i = 0; i < parts.length; i++)
	{
		var subject = parts[i];
		var iSubject = parseInt(subject);
		if (iSubject == subject)
		{
			untokenized[i] = parts[iSubject];
		}
		else
		{
			untokenized[i] = subject;
		}
	}
	
	return untokenized.join('|');
}

function encode()
{
	var encoded = '';
	var container = document.documentElement;
	var shadow = document.getElementById('grabzit-shadow');
	
	encoded = encodeChildren(container);
	var shadowEncoded = encodeChildren(shadow);
	
	alert(normalizeEncoding(encoded, shadowEncoded));
	
	var tokenized = tokenize(encoded);
	var compressed = LZString.compressToBase64(tokenized);
	/*
	if (compressed.length > 1024)
	{
		alert('The size of the web data you are trying to send to GrabzIt is too large. Try to reduce this by specifiying a id of a element that more tightly wraps the data you are interested in recording.');
		return;
	}*/
	
	var decompressed  = LZString.decompressFromBase64(compressed);
	var untokenized = untokenize(decompressed);
	//alert(untokenized);
	decode(untokenized);
}

function normalizeEncoding(encoded, shadowEncoded)
{
	var normalized = new Array();
	var parts = encoded.split('|');
	var shadowParts = shadowEncoded.split('|');
	var index = 0;
	
	for(var i = 0;i < shadowParts.length;i++)
	{
		var shadowPart = shadowParts[i];		
		
		for(var j = index;j < parts.length;j++)
		{
			var part = parts[j];
			
			if (shadowPart.indexOf('=') > -1)
			{
				if (shadowPart != part)
				{
					//It has been removed
					var bits = shadowPart.split('=');
					normalized.push(bits[0] + '=');
					break;
				}
				else
				{
					index++;
					break;
				}
			}
			else
			{						
				index++;
				normalized.push(part);
				
				if (shadowPart != part)
				{
					break;
				}
			}
		}
	}
	
	return normalized.join('|');
}

function shadowCopy()
{
	var doc = document.documentElement.cloneNode(true);
	var shadow = document.createElement("div");
	shadow.setAttribute("id", "grabzit-shadow");
	shadow.setAttribute("style", "display:none");
	shadow.appendChild(doc);
	
	document.documentElement.appendChild(shadow);
}

function encodeChildren(container)
{
	var encoded = '';	
	
	for(var i = 0;i < container.childNodes.length;i++)
	{
		var node = container.childNodes[i];
		var tagName = node.tagName;
		var innerText = '';
		var childCount = 0;

		if (tagName === undefined)
		{
			continue;
		}

		if (encoded != '' && encoded[encoded.length-1] != '|')
		{
			encoded += '|';
		}

		tagName = tagName.toLowerCase();

		if (tagName == 'br')
		{
			encoded += 'B';
		}
		else if (tagName == 'img')
		{
			encoded += 'I';
		}
		else if (tagName == 'input')
		{
			encoded += 'i';
		}
		else if (tagName == 'li')
		{
			encoded += 'l';
		}
		else if (tagName == 'span')
		{
			encoded += 's';
		}
		else if (tagName == 'fieldset')
		{
			encoded += 'f';
		}
		else if (tagName == 'form')
		{
			encoded += 'F';
		}	
		else if (tagName == 'ul')
		{
			encoded += 'u';
		}
		else
		{
			encoded += tagName;
		}

		if (node.childNodes.length > 0)
		{
			for(var x = 0;x < node.childNodes.length;x++)
			{
				var n = node.childNodes[x];
				if (n.nodeName)
				{
					childCount++;
				}
			}
			if (childCount > 0)
			{
				encoded += ':' + childCount;
			}
		}

		encoded += '|';

		if (node.value != null && node.value != '')
		{
			encoded += 'v=' + encodeURIComponent(node.value) + '|';
		}

		if (node.firstChild != null && node.firstChild.nodeValue != null && node.firstChild.nodeValue.replace(/(\r\n|\n|\r)/gm,"") != '')
		{
			encoded += 'C=' + encodeURIComponent(node.firstChild.nodeValue) + '|';
		}

		for(var j = 0;j < node.attributes.length;j++)
		{
			var attribute = node.attributes[j];
			var name = attribute.name;
			var value = attribute.value;

			if (name == 'onclick' || name == 'value')
			{
				//ignore all events and values
				continue;
			}

			if (encoded != '' && encoded[encoded.length-1] != '|')
			{
				encoded += '|';
			}

			if (name == 'type')
			{
				encoded += 't=';

				if (value == 'text')
				{
					encoded += 't';
				}
				else if (value == 'button')
				{
					encoded += 'b';
				}
				else
				{
					encoded += encodeURIComponent(value);
				}
			}
			else if (name == 'method')
			{
				encoded += 'm=';
				
				if (value == 'get')
				{
					encoded += 'g';
				}
				else if (value == 'post')
				{
					encoded += 'p';
				}
				else
				{
					encoded += encodeURIComponent(value);
				}				
			}
			else if (name == 'name')
			{
				encoded += 'n' + '=' + encodeURIComponent(value);
			}
			else if (name == 'id')
			{
				encoded += 'i' + '=' + encodeURIComponent(value);
			}
			else if (name == 'href')
			{
				encoded += 'h' + '=' + encodeUrl(value);
			}
			else if (name == 'class')
			{
				encoded += 'c' + '=' + encodeURIComponent(value);
			}
			else
			{
				encoded += name + '=' + encodeURIComponent(value);
			}
		}

		if (childCount > 0)
		{
			if (encoded != '' && encoded[encoded.length-1] != '|')
			{
				encoded += '|';
			}
			encoded += encodeChildren(node);
		}
	}
	return encoded;
}

function decodeAttributeValue(attr, attrValue)
{
	if (attr == 't')
	{
		if (attrValue == 't')
		{
			return 'text';
		}
		if (attrValue == 'b')
		{
			return 'button';
		}
	}
	if (attr == 'm')
	{
		if (attrValue == 'g')
		{
			return 'get';
		}
		if (attrValue == 'p')
		{
			return 'post';
		}
	}	
	if (attr == 'h')
	{
		return decodeUrl(attrValue);
	}

	return decodeURIComponent(attrValue);
}

function decodeAttribute(attr)
{
	if (attr == 'c')
	{
		return 'class';
	}
	if (attr == 't')
	{
		return 'type';
	}
	if (attr == 'v')
	{
		return 'value';
	}
	if (attr == 'm')
	{
		return 'method';
	}	
	if (attr == 'n')
	{
		return 'name';
	}
	if (attr == 'h')
	{
		return 'href';
	}
	if (attr == 'i')
	{
		return 'id';
	}

	return attr;
}

function endTag(html, tagName)
{
	if (html != '' && html[html.length-1] != '>')
	{
		html += '>';
	}
	return html;
}


function closeTag(html, tagName)
{
	if (html != '' && tagName != '')
	{
		html += '</' + tagName + '>';
	}
	return html;
}

function encodeUrl(url)
{
	if (document.location.hostname)
	{
		if (url.indexOf('http://'+document.location.hostname) == 0)
		{
			return '^1' + url.substring(('http://'+document.location.hostname).length, url.length);
		}
		if (url.indexOf('https://'+document.location.hostname) == 0)
		{
			return '^2' + url.substring(('https://'+document.location.hostname).length, url.length);
		}	
		if (url.indexOf(document.location.hostname) == 0)
		{
			return '^3' + url.substring(document.location.hostname.length, url.length);
		}	
	}	
	if (url.indexOf('http://www.') == 0)
	{
		return '^4' + url.substring(11, url.length);
	}
	if (url.indexOf('https://www.') == 0)
	{
		return '^5' + url.substring(12, url.length);
	}	
	if (url.indexOf('www.') == 0)
	{
		return '^6' + url.substring(4, url.length);
	}
	//Also do the current domain
	return url;
}

function decodeUrl(url)
{
	if (document.location.hostname)
	{
		if (url.indexOf('^1') == 0)
		{
			return 'http://'+document.location.hostname + url.substring(2, url.length);
		}
		if (url.indexOf('^2') == 0)
		{
			return 'https://'+document.location.hostname + url.substring(2, url.length);
		}	
		if (url.indexOf('^3') == 0)
		{
			return document.location.hostname + url.substring(11, url.length);
		}
	}	
	if (url.indexOf('^4') == 0)
	{
		return 'http://www.' + url.substring(2, url.length);
	}
	if (url.indexOf('^5') == 0)
	{
		return 'https://www.' + url.substring(2, url.length);
	}	
	if (url.indexOf('^6') == 0)
	{
		return 'www.' + url.substring(2, url.length);
	}
	//Also do the current domain
	return url;
}

function decode(encoded)
{
	previousChildCount = 0;
	decodePointer = 0;
	var parts = encoded.split('|');
	var decoded = decodeChildren(parts, 1, false);

	alert(decoded);
}

function decodeChildren(parts, limit, diving)
{
	var decoded = '';
	var tagName = '';
	var tagContent = '';
	var childCount = 0;
	var decodeOffset = 0;
	var currentLoopCount=0;

	if (diving)
	{
		decodePointer--;
	}

	var startingPart = parts[decodePointer];

	while(decodePointer < parts.length)
	{
		currentLoopCount++;
		var part = parts[decodePointer];
		decodePointer++;
		var index = part.indexOf('=');
		if (index > -1)
		{
			if (decoded != '' && decoded[decoded.length-1] != ' ')
			{
				decoded += ' ';
			}

			var attr = part.substring(0, index);

			if (attr == 'C')
			{
				//it's content!
				tagContent = decodeURIComponent(part.substring(index+1, part.length));
				continue;
			}

			decoded += decodeAttribute(attr);
			decoded += '="';
			decoded += decodeAttributeValue(attr, part.substring(index+1, part.length));
			decoded += '"';
		}
		else if (part != '')
		{
			var countIndex = part.indexOf(':');
			if (countIndex > -1)
			{
				childCount = parseInt(part.substring(countIndex + 1, part.length));
				part = part.substring(0, countIndex);
			}
			else
			{
				childCount = 0;
			}

			decoded = endTag(decoded, tagName);

			if (!diving || currentLoopCount > 1)
			{
				decoded += tagContent;
				tagContent = '';
				if (previousChildCount > 0)
				{
					var lastCount = previousChildCount;
					previousChildCount = childCount;
					var tmp = decodeChildren(parts, lastCount, true);
					decoded += tmp;
					continue;

				}
				else
				{
					previousChildCount = childCount;
				}

				decoded = closeTag(decoded, tagName);

				if (decodeOffset >= limit)
				{
					decodePointer--;
					return decoded;
				}

				tagName = '';
			}

			if (part == 'B')
			{
				//stops empty close tags
				tagName = '';
				decoded += '<br/>';
				continue;
			}

			if (part == 'i')
			{
				tagName = 'input';
			}
			else if (part == 'I')
			{
				tagName = 'img';
			}
			else if (part == 'l')
			{
				tagName = 'li';
			}
			else if (part == 'f')
			{
				tagName = 'fieldset';
			}
			else if (part == 'F')
			{
				tagName = 'form';
			}			
			else if (part == 's')
			{
				tagName = 'span';
			}
			else if (part == 'u')
			{
				tagName = 'ul';
			}
			else
			{
				tagName = part;
			}

			decoded += '<' + tagName;

			decodeOffset++;
		}
	}

	decoded = endTag(decoded, tagName);
	decoded = closeTag(decoded, tagName);

	return decoded;
}


	shadowCopy();
</script>
</head>
<body id="mBody">
<p>xzxcxzc zx cxz cz c zxc zxc zxc zxc z cz c z gdfg df gf gdfg gdf gfd gfg d gfd g dfbbcbvcb cvbvb vb  fghghgf h hfgsf Lorem ipsum dolor sit amet, consectetur adipsiscing elit. Cras in tempor enim, eget viverra nisi. Ut quam urna, sollicitudin eu erat id, blandit pulvinar nulla. Nunc rutrum ex eros, congue suscipit ligula viverra eu. In a feugiat velit. Interdum et malesuada fames ac ante ipsum primis in faucibus. Nunc eu placerat quam. Etiam tincidunt odio erat, a semper odio aliquet non. Pellentesque at dictum ligula, quis ornare felis. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut semper ante iaculis purus pretium, nec hendrerit ex sagittis. Donec in dui vel lectus pharetra hendrerit. Nam ut sem convallis, dictum ex at, viverra velit. Suspendisse hendrerit vulputate mollis.</p><p>Nulla facilisi. Nulla non nunc ipsum. Nam consectetur velit arcu, ut congue elit bibendum a. Donec sed eleifend eros, sit amet venenatis magna. Donec mi augue, rhoncus vel imperdiet sit amet, porta nec erat. Donec libero mauris, dictum eget risus non, vulputate luctus ante. Fusce semper ante elit, ut lacinia dolor luctus in. Praesent condimentum sapien id tellus imperdiet fringilla. Nunc quis odio rhoncus, luctus lectus eget, blandit enim. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Praesent purus lorem, aliquet in condimentum eu, pulvinar vitae neque. Maecenas non velit aliquet, egestas purus sit amet, feugiat sem. Nulla feugiat nunc volutpat augue ultrices, quis feugiat dui pharetra. Etiam eu dictum dui, aliquam dignissim magna. Etiam blandit ex eu vulputate malesuada.</p>
<form method="get" id="myForm">
<fieldset>
<p class="hello"><input type="text" name="name" value=""/><span id="job"><img/>
<span id="it"><a href="www.google.com">hello<ul><li></li></ul></a></span>
</span></p><br/>
<input type="text" value="" name="age"/>
<input type="text" value="" name="town"/>
<input type="button" value="Send" onclick="encode();"/>
</fieldset>
</form>
<p>Morbi quis scelerisque eros, cursus dignissim libero. Praesent finibus bibendum felis, ac iaculis ipsum mollis nec. Vestibulum consequat erat quis velit eleifend, ut ultrices ex convallis. Sed mi sapien, mollis vel metus ut, lobortis viverra nulla. Integer viverra elit nec neque vehicula, et vulputate lacus sollicitudin. Donec euismod aliquam pulvinar. Sed eget ante quis dui luctus tristique vel quis velit. Morbi sit amet nisi magna. Nulla dignissim mollis ex, vitae convallis metus sollicitudin sed. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer aliquet velit enim, pellentesque volutpat sem tristique imperdiet. Nunc gravida sapien eget diam bibendum dignissim. Fusce viverra sagittis est eu dictum. Nam posuere vulputate magna, eget sollicitudin tortor ullamcorper a. Aenean ac dolor lobortis, malesuada velit placerat, dapibus nibh.</p><p>Maecenas convallis pulvinar justo, nec faucibus neque maximus maximus. <a href="http://www.spacex.com" title="Go to space" class="grabzit-preview">Morbi</a> tristique, orci finibus congue feugiat, nibh purus sagittis turpis, sit amet pellentesque nisl mi vel nisl. Nunc maximus neque at pellentesque luctus. Aliquam et posuere sapien. Maecenas tincidunt lacus vitae metus facilisis, in ornare nisl molestie. Aliquam est nibh, sodales vitae eros in, hendrerit eleifend erat. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Etiam ornare quam quis molestie volutpat. Nullam tempor lorem massa, quis hendrerit libero consectetur eu. Proin posuere leo vitae mattis consectetur. Integer auctor luctus lectus. Suspendisse mollis nibh vehicula augue rutrum, id vehicula lacus scelerisque.</p><p>Proin placerat auctor euismod. Mauris et leo velit. In hac habitasse platea dictumst. Maecenas nec bibendum ipsum. Nunc vel vehicula velit. Nam sodales tellus eu ultricies commodo. Ut id metus quam. Integer sed consectetur sem, eu aliquam mi. Fusce arcu sapien, efficitur non dictum vitae, dictum in dolor.
</body>
</html>