<div id="a">
<span></br>abc<img src="bob.jpg"/></span>
<p>Hello there</p>
</div>
<div id="b">
<span class="hello">abc</span>
<p>Hello there</p>
</div>
<script>

function normalize(a, b)
{	
	if (a == null)
	{
		return;
	}
	
	var excludedNodes = new Array();
	
	if(a.isEqualNode(b))
	{
		if (typeof b.attributes != 'undefined')
		{
			for(var i = 0;i < b.attributes.length;i++)
			{
				b.removeAttribute(b.attributes[i].nodeName);
			}
		}
		b = removeAllTextNodes(b, function(o){excludedNodes.push(o);});
	}
	else if (a.tagName == b.tagName)
	{
		var aNodeText = getNodeText(a);
		var bNodeText = getNodeText(b);
		
		if (aNodeText == bNodeText && aNodeText != '' && bNodeText != '')
		{		
			b = removeAllTextNodes(b, function(o){excludedNodes.push(o);});
		}
	
		if (typeof b.attributes != 'undefined' && typeof a.attributes != 'undefined')
		{
			var attributesToRemove = new Array();
		
			for(var j = 0;j < b.attributes.length;j++)
			{		
				attributesToRemove.push(b.attributes[j].nodeName);
			}
			
			for(var i = 0;i < a.attributes.length;i++)
			{
				var aAtt = a.attributes[i];
				attributesToRemove.pop(aAtt.nodeName);
				var found = false;
				
				for(var j = 0;j < b.attributes;j++)
				{
					var bAtt = b.attributes[j];
					if (aAtt.nodeName == bAtt.nodeName)
					{
						found = true;					

						if (aAtt.value != bAtt.value)
						{
							b.setAttribute(bAtt.nodeName, bAtt.value);
						}
						else
						{
							b.removeAttribute(bAtt.nodeName);
						}
					}
				}

				if (!found)
				{
					b.setAttribute(aAtt.nodeName, aAtt.value);
				}
			}
			
			for (var j = 0;j < attributesToRemove.length;j++)
			{		
				b.setAttribute(attributesToRemove[j], "");
			}
		}
	}
	else
	{	
		if (b.parentNode == null || !containsNode(b.parentNode.childNodes, a))
		{
			if (typeof b.parentNode.attributes != 'undefined')
			{
				b.appendChild(a.cloneNode(true));				
			}
		}
		else if (a.nodeType != 3)
		{
			var parent = b.parentNode;
			parent.removeChild(b);
		}
		return;
	}
	var maximum = a.childNodes.length;
	if (maximum < b.childNodes.length)
	{
		maximum = b.childNodes.length;
	}
	
	var previousA = a;
	var previousB = b;
	for(var i = 0;i < maximum;i++)
	{
		var nextA = a.childNodes[i];
		var nextB = b.childNodes[i];
		if (nextB == null || nextB.nodeType != 1)
		{
			nextB = previousB;
		}
		else
		{
			previousB = nextB;
		}
		if (nextA == null)
		{
			nextA = previousA;
		}
		else
		{
			previousA = nextA;
		}
		
		if (containsNode(excludedNodes, nextA))
		{
			continue;
		}
		
		normalize(nextA, nextB);
	}	
}

function getNodeText(o)
{
	var text = "";
	for (var i = 0; i < o.childNodes.length; i++) {
		var curNode = o.childNodes[i];
		if (curNode.nodeType == 3) {
			text += curNode.nodeValue;
		}
	}
	text = text.replace(/(\r\n|\n|\r)/gm,"");
	return text;
}

function removeAllTextNodes(o, func)
{
	var emptied = false;
	for (var i = 0; i < o.childNodes.length; i++) {
		var curNode = o.childNodes[i];
		if (curNode.nodeType == 3) {
			func(curNode.cloneNode(false));
			o.removeChild(curNode);
			emptied = true;
		}
	}
	
	if (emptied)
	{
		o.setAttribute("grabzit-empty", "");
	}
	
	return o;
}

function containsNode(haystack, needle)
{
	for(var i = 0;i < haystack.length;i++)
	{
		if(needle.isEqualNode(haystack[i]))
		{
			return true;
		}
	}
	return false;
}

normalize(document.getElementById('a'), document.getElementById('b'));
</script>